"use strict";angular.module("dprCalcApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap"]).constant("_",window._).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/license/",{templateUrl:"views/openGameLicense.html"}).when("/class-list/",{templateUrl:"views/class-list.html",controller:"ClassListCtrl"}).otherwise({redirectTo:"/"})}]);var app=angular.module("dprCalcApp");app.service("pointBuyService",function(){var a={3:-4,4:-4,5:-4,6:-4,7:-4,8:-2,9:-1,10:0,11:1,12:2,13:3,14:5,15:7,16:10,17:13,18:17};return function(b){return _.reduce(b,function(b,c){return c=c>18?18:c,c=7>c?7:c,b+a[c]},0)}}),app.service("editService",function(){var a={id:null,value:null,target:null,source:null,dependentSources:null,dependentTargets:null,dependentValues:[]};return a.set=function(b,c,d,e,f){if(a.clear(),a.id=b,a.source=c,a.target=d,a.value=c[d],a.dependentSources=e,a.dependentTargets=f,a.dependentValue=[],e&&f)for(var g=0;g<e.length&&g<f.length;g++){var h=e[g],i=f[g];a.dependentValues[g]=h[i]}},a.clear=function(){if(a.id=null,a.dependentSources&&a.value===a.target[a.source])for(var b=0;b<a.dependentSources.length&&b<a.dependentTargets.length&&b<a.dependentValues.length;b++){var c=a.dependentSources[b],d=a.dependentTargets[b];c[d]=a.dependentValues[b]}},a.cancel=function(){a.source[a.tartet]=a.value,a.clear()},a}),app.service("abilityModService",function(){return function(a){return a=parseInt(a),Math.floor((a-10)/2)}}),app.service("abilityScoreService",function(){return["strength","dexterity","constitution","intelligence","wisdom","charisma"]}),app.service("statService",["bonusService","abilityModService",function(a,b){function c(c,d,e){var g;switch("string"==typeof e.type&&(e.type=parseInt(e.type)),e.type){case a.STATIC:g=e.value;break;case a.DYNAMIC:g=e.value;break;case a.ABILITY:var h=f(c,d,e.value);g=b(h);break;case a.STAT:g=f(c,d,e.value);break;case a.BASE_ABILITY:g=c.data.abilityScores[e.value];break;case a.DICE:var i=e.value.split("d");g=(parseInt(i[1])/2+.5)*parseInt(i[0]);break;case a.POWER_ATTACK_HIT:var j=f(c,d,"bab");g=-1*(Math.floor(j/4)+1);break;case a.POWER_ATTACK_DMG:var k=f(c,d,"bab");k=Math.floor(k/4)||1,g=e.value?3*k:2*k;break;case a.TWO_WEAPON:g=-2}if("string"==typeof g&&(g=parseFloat(g),g=isNaN(g)?0:g),e.modifier){var l=e.modifier;"string"==typeof l&&(l=d[l]||d.data[l]),g*=l,e.type!==a.DICE&&(g=Math.floor(g))}return g}function d(a){return"string"==typeof a&&(a=parseFloat(a),isNaN(a))?function(){return!1}:function(b){var c=parseFloat(b.name);return a>=c}}function e(a,b,d){return function(e,f){f=f.data?f.data:f;var g=_.reduce(f[d],function(d,e){return e.applyOnce&&f.level!==b.name?d:d+c(a,b,e)},0);return e+=g?g:0}}function f(a,b,c){var f=_.chain(a.data.levels).filter(d(b.name)).reduce(e(a,b,c),0).value();return f}function g(a,b,c,f){return _.chain(a.data.levels).filter(d(b.name)).map(function(a){var b={};return b[c]={},b[c][f]=a.data[c][f],b}).reduce(e(a,b,c),0).value()}return{get:f,getMod:g,getValue:c}}]),app.service("bonusService",function(){var a={STATIC:0,ABILITY:1,DYNAMIC:2,STAT:3,BASE_ABILITY:4,DICE:5,POWER_ATTACK_HIT:6,POWER_ATTACK_DMG:7,TWO_WEAPON:8};return a}),app.service("renderService",function(){var a={INLINE:0,HEADER:1,GROUP:2};return a}),app.factory("emptyCharacter",[function(){return function(){return{levels:[],race:"Human","class":"",abilityScores:{strength:10,dexterity:10,constitution:10,intelligence:10,wisdom:10,charisma:10}}}}]),app.factory("emptyLevel",["bonusService",function(a){return function(){return{name:1,level:1,attackGroups:[],selectedAttackGroupIndex:-1,selectedAttackGroup:null,strength:{increase:{type:a.DYNAMIC,value:0,order:1},"class":{type:a.DYNAMIC,value:0,order:2},enhance:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3},base:{type:a.BASE_ABILITY,value:"strength",applyOnce:!0,order:0}},dexterity:{increase:{type:a.DYNAMIC,value:0,order:1},"class":{type:a.DYNAMIC,value:0,order:2},enhance:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3},base:{type:a.BASE_ABILITY,value:"dexterity",applyOnce:!0,order:0}},constitution:{increase:{type:a.DYNAMIC,value:0,order:1},"class":{type:a.DYNAMIC,value:0,order:2},enhance:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3},base:{type:a.BASE_ABILITY,value:"constitution",applyOnce:!0,order:0}},intelligence:{increase:{type:a.DYNAMIC,value:0,order:1},"class":{type:a.DYNAMIC,value:0,order:2},enhance:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3},base:{type:a.BASE_ABILITY,value:"intelligence",applyOnce:!0,order:0}},wisdom:{increase:{type:a.DYNAMIC,value:0,order:1},"class":{type:a.DYNAMIC,value:0,order:2},enhance:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3},base:{type:a.BASE_ABILITY,value:"wisdom",applyOnce:!0,order:0}},charisma:{increase:{type:a.DYNAMIC,value:0,order:1},"class":{type:a.DYNAMIC,value:0,order:2},enhance:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3},base:{type:a.BASE_ABILITY,value:"charisma",applyOnce:!0,order:0}},ac:{base:{type:a.STATIC,value:10,"flat-footed":!0,touch:!0,applyOnce:!0,order:0},armor:{type:a.DYNAMIC,value:0,"flat-footed":!0,touch:!1,applyOnce:!0,order:1},shield:{type:a.DYNAMIC,value:0,"flat-footed":!0,touch:!1,applyOnce:!0,order:2},dexterity:{type:a.ABILITY,value:"dexterity","flat-footed":!1,touch:!0,title:"Dex",applyOnce:!0,order:3},size:{type:a.DYNAMIC,value:0,"flat-footed":!0,touch:!0,applyOnce:!0,order:4},natural:{type:a.DYNAMIC,value:0,"flat-footed":!0,touch:!1,applyOnce:!0,order:5},deflection:{type:a.DYNAMIC,value:0,"flat-footed":!0,touch:!0,applyOnce:!0,order:6},dodge:{type:a.DYNAMIC,value:0,"flat-footed":!1,touch:!0,applyOnce:!0,order:7},touch:{type:a.DYNAMIC,value:0,"flat-footed":!1,touch:!0,applyOnce:!0,order:8},"flat-footed":{type:a.DYNAMIC,value:0,"flat-footed":!0,touch:!1,applyOnce:!0,order:9}},fortitude:{base:{type:a.DYNAMIC,value:0,order:0},constitution:{type:a.ABILITY,value:"constitution",applyOnce:!0,title:"Ability",order:1},magic:{type:a.DYNAMIC,value:0,applyOnce:!0,order:2},misc:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3}},reflex:{base:{type:a.DYNAMIC,value:0,order:0},dexterity:{type:a.ABILITY,value:"dexterity",applyOnce:!0,title:"Ability",order:1},magic:{type:a.DYNAMIC,value:0,applyOnce:!0,order:2},misc:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3}},will:{base:{type:a.DYNAMIC,value:0,order:0},wisdom:{type:a.ABILITY,value:"wisdom",applyOnce:!0,title:"Abililty",order:1},magic:{type:a.DYNAMIC,value:0,applyOnce:!0,order:2},misc:{type:a.DYNAMIC,value:0,applyOnce:!0,order:3}},dr:{base:{type:a.DYNAMIC,value:0,applyOnce:!0,order:0},"class":{type:a.DYNAMIC,value:0,order:1}},sr:{base:{type:a.DYNAMIC,value:0,order:0},"class":{type:a.DYNAMIC,value:0,order:1},enhance:{type:a.DYNAMIC,value:0,applyOnce:!0,order:2}},hp:{level:{type:a.DYNAMIC,value:0,order:0},constitution:{type:a.ABILITY,value:"constitution",title:"Con",applyOnce:!0,modifier:"level",order:1},favoured:{type:a.DYNAMIC,value:0,order:2},toughness:{type:a.DYNAMIC,value:0,order:3},other:{type:a.DYNAMIC,value:0,order:4}},bab:{"class":{type:a.DYNAMIC,value:0,order:0}},initiative:{dexterity:{type:a.ABILITY,value:"dexterity",applyOnce:!0,order:0,title:"Dex"},"class":{type:a.DYNAMIC,value:0,order:2},misc:{type:a.DYNAMIC,value:0,applyOnce:!0,order:1}},movement:{base:30,armor:30,fly:0,swim:0,climb:0,burrow:0},equipment:[],feats:[],skills:[],"spell-casting":[],abilities:[]}}}]),app.filter("orderObjectBy",function(){return function(a,b,c){return _.chain(_.keys(a)).map(function(b){var c=a[b];return c._objectKey=b,c}).sortBy(function(a){return c?-a[b]:a[b]}).value()}}),app.directive("tabs",function(){return{restrict:"E",templateUrl:"../views/horizontal-tabs.html",scope:{tabs:"=tabs",css:"=css",selected:"=selected",unselected:"=unselected",name:"=itemname"}}}),app.directive("inputField",["editService",function(a){return{restrict:"E",templateUrl:"../views/input-field.html",transclude:!0,scope:{cssClass:"=css",type:"=type",editId:"=id",editTarget:"=target",editSource:"=source",title:"=title",step:"=step"},link:function(b){b.edit=a}}}]),app.directive("inputAbility",["editService","abilityModService",function(a,b){return{restrict:"E",templateUrl:"../views/input-ability.html",transclude:!0,scope:{scores:"=scores",target:"=source"},link:function(c){c.edit=a,c.getAbilityMod=b}}}]),app.directive("standardStats",["editService","abilityModService","bonusService","renderService","statService",function(a,b,c,d,e){return{restrict:"E",transclude:!0,scope:{character:"=character",level:"=level"},templateUrl:"../views/standard-stats.html",link:function(f){f.edit=a,f.standardStats=[{title:"Ability",renderType:d.GROUP,items:[{name:"strength",title:"Str"},{name:"dexterity",title:"Dex"},{name:"constitution",title:"Con"},{name:"intelligence",title:"Int"},{name:"wisdom",title:"Wis"},{name:"charisma",title:"Cha"}],additionalColumns:[{name:"mod",title:"Modifier",value:b,order:0,position:0}]},{name:"hp",title:"HP",renderType:d.HEADER},{name:"ac",title:"AC",renderType:d.HEADER},{title:"Saves",renderType:d.GROUP,items:[{name:"fortitude",title:"Fort"},{name:"reflex",title:"Ref"},{name:"will",title:"Will"}]},{name:"initiative",title:"Init",renderType:d.INLINE},{name:"bab",title:"BAB",renderType:d.INLINE},{name:"dr",title:"DR",renderType:d.INLINE},{name:"sr",title:"SR",renderType:d.INLINE}],f.RENDER_TYPE=d,f.BONUS_TYPE=c,f.getStat=e.get,f.getStatMod=e.getMod,f.getValue=e.getValue}}}]),app.controller("TabsCharacterController",["$scope","emptyCharacter","editService",function(a,b,c){function d(){angular.forEach(a.characters,function(a){a.active=!1})}function e(){f++,a.characters.push({id:f,name:"character "+f,active:!0,data:b()})}a.edit=c;var f=0;a.remove=function(b){if(1!==a.characters.length){var c=a.characters[b].active;a.characters.splice(b,1),c&&(a.characters.length>b?a.characters[b].active=!0:a.characters[b-1].active=!0)}},a.characters=[],a.add=function(){a.edit.clear(),d(),e()},a.add()}]),app.directive("character",["abilityScoreService","pointBuyService","emptyLevel","editService",function(a,b,c,d){return{restrict:"E",scope:{character:"=character"},templateUrl:"../views/character.html",controller:["$scope",function(e){function f(){angular.forEach(e.character.data.levels,function(a){a.active=!1})}function g(){var a=_.reduce(e.character.data.levels,function(a,b){var c=parseInt(b.name);return a>c?a:c},0);a++,e.character.data.levels.push({id:a,name:a,active:!0,data:c()})}e.edit=d,e.abilityScores=a,e.pointBuy=b,e.remove=function(a){if(1!==e.character.data.levels.length){var b=e.character.data.levels[a].active;b&&f(),e.character.data.levels.splice(a,1),b&&(e.character.data.levels.length>a?e.character.data.levels[a].active=!0:e.character.data.levels[a-1].active=!0)}},e.add=function(){e.edit.clear(),f(),g()}}]}}]),app.directive("level",[function(){return{restrict:"E",scope:{level:"=level",character:"=character"},templateUrl:"../views/level.html",controller:function(){}}}]),app.directive("standardStatInline",["editService","abilityModService","bonusService","statService",function(a,b,c,d){return{restrict:"E",transclude:!0,scope:{character:"=character",level:"=level",stat:"=stat"},templateUrl:"../views/standard-stat-inline.html",link:function(b){b.edit=a,b.BONUS_TYPE=c,b.getStat=d.get,b.getStatMod=d.getMod,b.getValue=d.getValue}}}]),app.directive("standardStatHeader",["editService","abilityModService","bonusService","statService",function(a,b,c,d){return{restrict:"E",transclude:!0,scope:{character:"=character",level:"=level",stat:"=stat"},templateUrl:"../views/standard-stat-header.html",link:function(b){b.edit=a,b.BONUS_TYPE=c,b.getStat=d.get,b.getStatMod=d.getMod,b.getValue=d.getValue}}}]),app.directive("standardStatGroup",["editService","abilityModService","bonusService","statService",function(a,b,c,d){return{restrict:"E",transclude:!0,scope:{character:"=character",level:"=level",stat:"=stat"},templateUrl:"../views/standard-stat-group.html",link:function(b){b.edit=a,b.BONUS_TYPE=c,b.getStat=d.get,b.getStatMod=d.getMod,b.getValue=d.getValue}}}]),app.controller("MainCtrl",["$scope","$filter","editService",function(a,b,c){function d(b,c,d){var e;switch("string"==typeof d.type&&(d.type=parseInt(d.type)),d.type){case o.STATIC:e=d.value;break;case o.DYNAMIC:e=d.value;break;case o.ABILITY:var f=a.getStat(b,c,d.value);e=a.getAbilityMod(f);break;case o.STAT:e=a.getStat(b,c,d.value);break;case o.BASE_ABILITY:e=b.abilityScores[d.value];break;case o.DICE:var g=d.value.split("d");e=(parseInt(g[1])/2+.5)*parseInt(g[0]);break;case o.POWER_ATTACK_HIT:var h=a.getStat(b,c,"bab");e=-1*(Math.floor(h/4)+1);break;case o.POWER_ATTACK_DMG:var i=a.getStat(b,c,"bab");i=Math.floor(i/4)||1,e=d.value?3*i:2*i;break;case o.TWO_WEAPON:e=-2}if("string"==typeof e&&(e=parseFloat(e),e=isNaN(e)?0:e),d.modifier){var j=d.modifier;"string"==typeof j&&(j=c[j]),e*=j,d.type!==o.DICE&&(e=Math.floor(e))}return e}function e(){return{name:"Name",selectedAttack:null,selectedAttackIndex:null,attacks:[f()]}}function f(){return{weapon:"attack",damage:[{type:o.DICE,value:"1d8",modifier:1,percision:!1},{type:o.ABILITY,value:"strength",modifier:1,percision:!1}],hitChance:[{type:o.STAT,value:"bab"},{type:o.ABILITY,value:"strength"}],critThreat:.05,critMultiplier:2}}function g(){return{type:o.DYNAMIC,value:0}}function h(){return{type:o.DICE,value:"1d8",modifier:1,percision:!1}}function i(){var a=Math.floor(255*Math.random()),b=Math.floor(255*Math.random()),c=Math.floor(255*Math.random()),d=.5,e=1,f="rgba("+a+","+b+","+c+","+d+")",g="rgba("+a+","+b+","+c+","+e+")";return{fill:f,stroke:g,point:f}}function j(){n&&n.destroy();var b,c=[];for(var d in a.characters){var e=a.characters[d];for(var f in e.levels){var g=e.levels[f];c.push(g.name)}e.colors||(e.colors=i(),e.style={"background-color":e.colors.fill})}c=_.uniq(c),b=_.map(a.characters,function(b){return{label:b.name,fillColor:b.colors.fill,strokeColor:b.colors.stroke,pointColor:b.colors.point,pointStrokeColor:"#FFF",pointHighlightFill:"#FFF",pointHighlighStroke:"#FFF",data:_.map(c,function(c){var d=_.find(b.levels,function(a){return a.level===c});return d?_.reduce(d.attackGroups,function(c,e){var f=a.calculateDPR(b,d,e);return c>f?c:f},0):0})}});var h={labels:c,datasets:b};n=new Chart(p).Line(h),window.setTimeout(function(){n.resize()},1e3)}function k(a,b,c){return _.reduce(c.hitChance,function(c,e){return c+=d(a,b,e)},0)}function l(a,b,c,e){var f=0,g=0;for(var h in c.damage){var i=c.damage[h],j=d(a,b,i);i.percision?g+=j:f+=j}return f=0>f?0:f,g=0>g?0:g,e?{damage:f,percision:g}:g?f+" and percision: "+g:f}function m(b,c,d){var e,f=parseInt(c.name),g=a.targetAc[f],h=.05,i=.95,j=0,m=0,n=k(b,c,d),o=l(b,c,d,!0);return j=o.damage,m=o.percision,e=1-(g-n)/20,e=h>e?h:e,e=e>i?i:e,e*(j+m)+d.critThreat*(d.critMultiplier-1)*e*j}a.edit=c;var n,o={STATIC:0,ABILITY:1,DYNAMIC:2,STAT:3,BASE_ABILITY:4,DICE:5,POWER_ATTACK_HIT:6,POWER_ATTACK_DMG:7,TWO_WEAPON:8},p=null;a.graphDPR=function(){c.id="graph",window.setTimeout(j,100)},a.importExport=null,a["export"]=function(){a.importExport=b("json")(a.selectedCharacter,4),a.edit.id="export"},a.importStart=function(){a.importExport="",a.edit.id="import"},a.importPaste=function(b){a.importExport=b.target.value},a.importEnd=function(){a.selectedCharacter=angular.fromJson(a.importExport),a.characters[a.selectedCharacterIndex]=a.selectedCharacter,a.edit.id=null},a.selectAttackGroup=function(b,c){a.edit.clear(),b.selectedAttackGroupIndex=c,-1===c?b.selectedAttackGroup=null:b.selectedAttackGroup=b.attackGroups[c]},a.addAttackGroup=function(b){b.attackGroups.push(e()),a.selectAttackGroup(b,b.attackGroups.length-1)},a.removeAttackGroup=function(b,c){b.attackGroups.splice(c,1),b.selectedAttackGroupIndex===c&&a.selectAttackGroup(b,-1),b.selectedAttackGroupIndex>=c?0===c||0===b.selectedAttackGroupIndex?a.selectAttackGroup(b,0):a.selectAttackGroup(b,b.selectedAttackGroupIndex-1):b.selectedAttackGroupIndex>b.attackGroups.lenth-1&&a.selectAttackGroup(b,b.attackGroups.length-1)},a.copyAttackGroupFromPreviousLevel=function(a,b){var c=parseInt(b.name),d=_.reduce(a.levels,function(a,b){var d=parseInt(b.level),e=parseInt(a.level);return c>d&&(!a||d>e)?b:a},!1);d&&(b.attackGroups=b.attackGroups.concat(angular.copy(d.attackGroups)))},a.selectAttack=function(b,c){a.edit.clear(),b.selectedAttackIndex=c,-1===c?b.selectedAttack=null:b.selectedAttack=b.attacks[c]},a.addAttack=function(b){b.attacks.push(f()),a.selectAttack(b,b.attacks.length-1)},a.removeAttack=function(b,c){b.attacks.splice(c,1),b.selectedAttackIndex===c&&a.selectAttack(b,-1),b.selectedAttackIndex>=c?0===c||0===b.selectedAttackIndex?a.selectAttack(b,0):a.selectAttack(b,b.selectedAttackIndex-1):b.selectedAttackIndex>b.attacks.lenth-1&&a.selectAttack(b,b.attacks.length-1)},a.addHit=function(a){a.hitChance.push(g())},a.removeHit=function(a,b){a.hitChance.splice(b,1)},a.addDmg=function(a){a.damage.push(h())},a.removeDmg=function(a,b){a.damage.splice(b,1)},a.calculateAttackDPR=m,a.calculateDPR=function(a,b,c){return _.reduce(c.attacks,function(c,d){return c+=m(a,b,d)},0)},a.getHit=k,a.getDmg=l,a.abilityScores=["strength","dexterity","constitution","intelligence","wisdom","charisma"],a.pointBuy={3:-4,4:-4,5:-4,6:-4,7:-4,8:-2,9:-1,10:0,11:1,12:2,13:3,14:5,15:7,16:10,17:13,18:17},a.targetAc={1:12,2:14,3:15,4:17,5:18,6:19,7:20,8:21,9:23,10:24,11:25,12:27,13:28,14:29,15:30,16:31,17:32,18:33,19:34,20:36}}]),angular.module("dprCalcApp").controller("ClassListCtrl",["$scope","$http",function(a,b){function c(b){a.classes=a.classes.concat(b)}var d=["acg","crb","apg","uc","um"];a.classes=[];for(var e in d)b.get("data/"+d[e]+"/class-list.json").success(c);a.options={bab:["1","0.75","0.5"],hd:["12","10","8","6"],skills:["8","6","4","2"],saves:["HIGH","LOW"]},a.orderProp="name"}]);